From d064745963b86a3250b15dfd117ff0a9aada235c Mon Sep 17 00:00:00 2001
From: Yaroslav Zviezda <acroreiser@gmail.com>
Date: Sun, 7 Apr 2024 21:24:37 +0300
Subject: [PATCH 1/5] Revert "Migrate libwifi-hal-qcom to Android.bp"

This reverts commit 1dfa583cb0cf8863d0069dc80df50c4c54191a32.
---
 libwifi_hal/Android.bp | 128 ++++++++++++++++++++++++++++++++++++++++-
 1 file changed, 127 insertions(+), 1 deletion(-)

diff --git a/libwifi_hal/Android.bp b/libwifi_hal/Android.bp
index 1af3df0..5eec720 100644
--- a/libwifi_hal/Android.bp
+++ b/libwifi_hal/Android.bp
@@ -162,7 +162,7 @@ wifi_cc_defaults {
                 whole_static_libs: ["libwifi-hal-syna"],
             },
             qcwcn: {
-                defaults: ["libwifi-hal-qcom"],
+                whole_static_libs: ["libwifi-hal-qcom"],
             },
             mrvl: {
                 // this is commented because none of the nexus devices
@@ -206,6 +206,9 @@ wifi_cc_defaults {
                 shared_libs: ["libcrypto"],
                 defaults: ["google_wifi_config_lib_defaults"],
             },
+            qcwcn: {
+                shared_libs: ["libcld80211", "libcrypto"],
+            },
         },
     },
 }
@@ -241,3 +244,126 @@ cc_library_shared {
         integer_overflow: true,
     },
 }
+
+// Expose make-built libwifi-hal-<vendor> via wifi_cc_prebuilt_library_static.
+
+// Licenses for imported libwifi-hal-<vendor> libraries
+
+license {
+    name: "libwifi_hal_apache20_license",
+    visibility: [":__subpackages__"],
+    license_kinds: [
+        "SPDX-license-identifier-Apache-2.0",
+    ],
+}
+
+license {
+    name: "libwifi_hal_bsd_license",
+    visibility: [":__subpackages__"],
+    license_kinds: [
+        "SPDX-license-identifier-BSD",
+    ],
+}
+
+// Additional soong_config_module_types to enable/disable according to BOARD_WLAN_DEVICE
+// If libwifi-hal-<vendor> libs are migrated to soong modules, these are not necessary.
+
+soong_config_module_type {
+    name: "wifi_cc_prebuilt_library_static",
+    module_type: "cc_prebuilt_library_static",
+    config_namespace: "wifi",
+    variables: [
+        "board_wlan_device", // BOARD_WLAN_DEVICE
+    ],
+    properties: [
+        "enabled",
+    ],
+}
+
+soong_config_module_type {
+    name: "wifi_cc_prebuilt_library_shared",
+    module_type: "cc_prebuilt_library_shared",
+    config_namespace: "wifi",
+    variables: [
+        "board_wlan_device", // BOARD_WLAN_DEVICE
+    ],
+    properties: [
+        "enabled",
+    ],
+}
+
+soong_config_module_type {
+    name: "wifi_makefile_goal",
+    module_type: "makefile_goal",
+    config_namespace: "wifi",
+    variables: [
+        "board_wlan_device", // BOARD_WLAN_DEVICE
+    ],
+    properties: [
+        "enabled",
+    ],
+}
+
+// libwifi-hal-qcom
+
+wifi_cc_prebuilt_library_static {
+    name: "libwifi-hal-qcom",
+    proprietary: true,
+    srcs: [":make-libwifi-hal-qcom"],
+    compile_multilib: "first",
+    installable: false,
+    licenses: ["libwifi_hal_apache20_license", "libwifi_hal_bsd_license"],
+    enabled: false,
+    soong_config_variables: {
+        board_wlan_device: {
+            qcwcn: {
+                enabled: true,
+            },
+        },
+    },
+}
+
+wifi_makefile_goal {
+    name: "make-libwifi-hal-qcom",
+    product_out_path: "obj/STATIC_LIBRARIES/libwifi-hal-qcom_intermediates/libwifi-hal-qcom.a",
+    enabled: false,
+    soong_config_variables: {
+        board_wlan_device: {
+            qcwcn: {
+                enabled: true,
+            },
+        },
+    },
+}
+
+// libcld80211
+
+wifi_cc_prebuilt_library_shared {
+    name: "libcld80211",
+    vendor: true,
+    srcs: [":make-libcld80211"],
+    compile_multilib: "first",
+    installable: false,
+    licenses: ["libwifi_hal_bsd_license"],
+    enabled: false,
+    soong_config_variables: {
+        board_wlan_device: {
+            qcwcn: {
+                enabled: true,
+            },
+        },
+    },
+}
+
+wifi_makefile_goal {
+    name: "make-libcld80211",
+    product_out_path: "obj/SHARED_LIBRARIES/libcld80211_intermediates/LINKED/libcld80211.so",
+    enabled: false,
+    soong_config_variables: {
+        board_wlan_device: {
+            qcwcn: {
+                enabled: true,
+            },
+        },
+    },
+}
-- 
2.45.2

