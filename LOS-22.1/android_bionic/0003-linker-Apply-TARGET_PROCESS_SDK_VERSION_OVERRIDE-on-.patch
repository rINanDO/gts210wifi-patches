From bd3257ac555d6f51a4b1720f648c93cc7878f412 Mon Sep 17 00:00:00 2001
From: Dominggoes Isakh <drjisakh@gmail.com>
Date: Tue, 10 Dec 2019 22:34:55 +0100
Subject: [PATCH 03/10] linker: Apply TARGET_PROCESS_SDK_VERSION_OVERRIDE on
 dlopen

Change-Id: I2d93f81315fcb67cc3fd102f45d9db8f84e2ff12
Signed-off-by: Dominggoes Isakh <drjisakh@gmail.com>
---
 linker/linker.cpp | 13 ++++++++++++-
 1 file changed, 12 insertions(+), 1 deletion(-)

diff --git a/linker/linker.cpp b/linker/linker.cpp
index e3f1d77bb..fc669cebb 100644
--- a/linker/linker.cpp
+++ b/linker/linker.cpp
@@ -3420,6 +3420,17 @@ bool soinfo::link_image(const SymbolLookupList& lookup_list, soinfo* local_group
   if (has_text_relocations) {
     // Fail if app is targeting M or above.
     int app_target_api_level = get_application_target_sdk_version();
+#ifdef SDK_VERSION_OVERRIDES
+    for (const auto& entry : android::base::Split(SDK_VERSION_OVERRIDES, " ")) {
+      auto splitted = android::base::Split(entry, "=");
+      if (splitted.size() == 2 && splitted[0] == get_realpath()) {
+        app_target_api_level = static_cast<uint32_t>(std::stoul(splitted[1]));
+        LD_DEBUG(any, "\"%s\" has text relocations. Overriding sdk version %d to %d", get_realpath(), get_application_target_sdk_version(), app_target_api_level);
+        break;
+      }
+    }
+#endif
+
     if (app_target_api_level >= 23) {
       DL_ERR_AND_LOG("\"%s\" has text relocations (%s#Text-Relocations-Enforced-for-API-level-23)",
                      get_realpath(), kBionicChangesUrl);
@@ -3718,7 +3729,7 @@ std::vector<android_namespace_t*> init_default_namespaces(const char* executable
       break;
     }
   }
-  DEBUG("Target SDK for %s = %d", executable_path, target_sdk);
+  LD_DEBUG(any, "Target SDK for %s = %d", executable_path, target_sdk);
 #endif
   set_application_target_sdk_version(target_sdk);
 
-- 
2.45.2

