From 9a7422e39b8459c59f9a1113f56ad0694be493fc Mon Sep 17 00:00:00 2001
From: Yaroslav Zviezda <acroreiser@gmail.com>
Date: Wed, 29 Dec 2021 11:41:03 +0300
Subject: [PATCH 1/3] [U] sepolicy: allow su domain in user builds

Do not use for anything except boot time one shot scripts.

Change-Id: I3ac61e9e3e9741d512ece95c86a8e7ee1617a926
---
 build/soong/policy.go              |  4 ++--
 prebuilts/api/30.0/private/init.te | 10 +++++-----
 prebuilts/api/30.0/private/su.te   |  2 --
 prebuilts/api/31.0/private/init.te | 10 +++++-----
 prebuilts/api/31.0/private/su.te   |  3 ---
 prebuilts/api/32.0/private/init.te | 10 +++++-----
 prebuilts/api/32.0/private/su.te   |  3 ---
 prebuilts/api/33.0/private/init.te | 10 +++++-----
 prebuilts/api/33.0/private/su.te   |  3 ---
 prebuilts/api/34.0/private/init.te | 10 +++++-----
 prebuilts/api/34.0/private/su.te   |  2 --
 private/init.te                    | 10 +++++-----
 private/su.te                      |  2 --
 13 files changed, 32 insertions(+), 47 deletions(-)

diff --git a/build/soong/policy.go b/build/soong/policy.go
index cbcc57ae6..e2c0e8fa2 100644
--- a/build/soong/policy.go
+++ b/build/soong/policy.go
@@ -558,7 +558,7 @@ func (c *policyBinary) GenerateAndroidBuildActions(ctx android.ModuleContext) {
 		rule.Temporary(permissiveDomains)
 
 		msg := `==========\n` +
-			`ERROR: permissive domains not allowed in user builds\n` +
+			`WARNING: permissive domains not allowed in user builds\n` +
 			`List of invalid domains:`
 
 		rule.Command().Text("if test").
@@ -568,7 +568,7 @@ func (c *policyBinary) GenerateAndroidBuildActions(ctx android.ModuleContext) {
 			Text(`"` + msg + `"`).
 			Text("&& cat ").
 			Input(permissiveDomains).
-			Text("; exit 1; fi")
+			Text("; fi")
 	}
 
 	out := pathForModuleOut(ctx, c.stem())
diff --git a/prebuilts/api/30.0/private/init.te b/prebuilts/api/30.0/private/init.te
index b0e7f809a..e40b15928 100644
--- a/prebuilts/api/30.0/private/init.te
+++ b/prebuilts/api/30.0/private/init.te
@@ -24,13 +24,13 @@ domain_trans(init, { rootfs toolbox_exec }, modprobe)
 userdebug_or_eng(`
   # case where logpersistd is actually logcat -f in logd context (nee: logcatd)
   domain_auto_trans(init, logcat_exec, logpersist)
-
-  # allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
-  allow init su:process transition;
-  dontaudit init su:process noatsecure;
-  allow init su:process { siginh rlimitinh };
 ')
 
+# allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
+allow init su:process transition;
+dontaudit init su:process noatsecure;
+allow init su:process { siginh rlimitinh };
+
 # Allow init to figure out name of dm-device from it's /dev/block/dm-XX path.
 # This is useful in case of remounting ext4 userdata into checkpointing mode,
 # since it potentially requires tearing down dm-devices (e.g. dm-bow, dm-crypto)
diff --git a/prebuilts/api/30.0/private/su.te b/prebuilts/api/30.0/private/su.te
index 16e47bbbf..8ed6ee8c4 100644
--- a/prebuilts/api/30.0/private/su.te
+++ b/prebuilts/api/30.0/private/su.te
@@ -1,4 +1,3 @@
-userdebug_or_eng(`
   typeattribute su coredomain;
 
   domain_auto_trans(shell, su_exec, su)
@@ -20,4 +19,3 @@ userdebug_or_eng(`
   permissive su;
 
   app_domain(su)
-')
diff --git a/prebuilts/api/31.0/private/init.te b/prebuilts/api/31.0/private/init.te
index f569e0c2d..7eac8d726 100644
--- a/prebuilts/api/31.0/private/init.te
+++ b/prebuilts/api/31.0/private/init.te
@@ -25,13 +25,13 @@ domain_trans(init, { rootfs toolbox_exec }, modprobe)
 userdebug_or_eng(`
   # case where logpersistd is actually logcat -f in logd context (nee: logcatd)
   domain_auto_trans(init, logcat_exec, logpersist)
-
-  # allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
-  allow init su:process transition;
-  dontaudit init su:process noatsecure;
-  allow init su:process { siginh rlimitinh };
 ')
 
+# allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
+allow init su:process transition;
+dontaudit init su:process noatsecure;
+allow init su:process { siginh rlimitinh };
+
 # Allow init to figure out name of dm-device from it's /dev/block/dm-XX path.
 # This is useful in case of remounting ext4 userdata into checkpointing mode,
 # since it potentially requires tearing down dm-devices (e.g. dm-bow, dm-crypto)
diff --git a/prebuilts/api/31.0/private/su.te b/prebuilts/api/31.0/private/su.te
index 587f449fb..73e894454 100644
--- a/prebuilts/api/31.0/private/su.te
+++ b/prebuilts/api/31.0/private/su.te
@@ -1,4 +1,3 @@
-userdebug_or_eng(`
   typeattribute su coredomain;
 
   domain_auto_trans(shell, su_exec, su)
@@ -26,5 +25,3 @@ userdebug_or_eng(`
 
   # Do not audit accesses to keystore2 namespace for the su domain.
   dontaudit su keystore2_key_type:{ keystore2 keystore2_key } *;
-
-')
diff --git a/prebuilts/api/32.0/private/init.te b/prebuilts/api/32.0/private/init.te
index 200780dfb..23610448a 100644
--- a/prebuilts/api/32.0/private/init.te
+++ b/prebuilts/api/32.0/private/init.te
@@ -25,13 +25,13 @@ domain_trans(init, { rootfs toolbox_exec }, modprobe)
 userdebug_or_eng(`
   # case where logpersistd is actually logcat -f in logd context (nee: logcatd)
   domain_auto_trans(init, logcat_exec, logpersist)
-
-  # allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
-  allow init su:process transition;
-  dontaudit init su:process noatsecure;
-  allow init su:process { siginh rlimitinh };
 ')
 
+# allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
+allow init su:process transition;
+dontaudit init su:process noatsecure;
+allow init su:process { siginh rlimitinh };
+
 # Allow init to figure out name of dm-device from it's /dev/block/dm-XX path.
 # This is useful in case of remounting ext4 userdata into checkpointing mode,
 # since it potentially requires tearing down dm-devices (e.g. dm-bow, dm-crypto)
diff --git a/prebuilts/api/32.0/private/su.te b/prebuilts/api/32.0/private/su.te
index 587f449fb..73e894454 100644
--- a/prebuilts/api/32.0/private/su.te
+++ b/prebuilts/api/32.0/private/su.te
@@ -1,4 +1,3 @@
-userdebug_or_eng(`
   typeattribute su coredomain;
 
   domain_auto_trans(shell, su_exec, su)
@@ -26,5 +25,3 @@ userdebug_or_eng(`
 
   # Do not audit accesses to keystore2 namespace for the su domain.
   dontaudit su keystore2_key_type:{ keystore2 keystore2_key } *;
-
-')
diff --git a/prebuilts/api/33.0/private/init.te b/prebuilts/api/33.0/private/init.te
index 17e25f895..c73847378 100644
--- a/prebuilts/api/33.0/private/init.te
+++ b/prebuilts/api/33.0/private/init.te
@@ -26,13 +26,13 @@ domain_trans(init, { rootfs toolbox_exec }, modprobe)
 userdebug_or_eng(`
   # case where logpersistd is actually logcat -f in logd context (nee: logcatd)
   domain_auto_trans(init, logcat_exec, logpersist)
-
-  # allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
-  allow init su:process transition;
-  dontaudit init su:process noatsecure;
-  allow init su:process { siginh rlimitinh };
 ')
 
+# allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
+allow init su:process transition;
+dontaudit init su:process noatsecure;
+allow init su:process { siginh rlimitinh };
+
 # Allow init to figure out name of dm-device from it's /dev/block/dm-XX path.
 # This is useful in case of remounting ext4 userdata into checkpointing mode,
 # since it potentially requires tearing down dm-devices (e.g. dm-bow, dm-crypto)
diff --git a/prebuilts/api/33.0/private/su.te b/prebuilts/api/33.0/private/su.te
index 587f449fb..73e894454 100644
--- a/prebuilts/api/33.0/private/su.te
+++ b/prebuilts/api/33.0/private/su.te
@@ -1,4 +1,3 @@
-userdebug_or_eng(`
   typeattribute su coredomain;
 
   domain_auto_trans(shell, su_exec, su)
@@ -26,5 +25,3 @@ userdebug_or_eng(`
 
   # Do not audit accesses to keystore2 namespace for the su domain.
   dontaudit su keystore2_key_type:{ keystore2 keystore2_key } *;
-
-')
diff --git a/prebuilts/api/34.0/private/init.te b/prebuilts/api/34.0/private/init.te
index 9d3a2c380..f34d166ab 100644
--- a/prebuilts/api/34.0/private/init.te
+++ b/prebuilts/api/34.0/private/init.te
@@ -28,13 +28,13 @@ domain_trans(init, { rootfs toolbox_exec }, modprobe)
 userdebug_or_eng(`
   # case where logpersistd is actually logcat -f in logd context (nee: logcatd)
   domain_auto_trans(init, logcat_exec, logpersist)
-
-  # allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
-  allow init su:process transition;
-  dontaudit init su:process noatsecure;
-  allow init su:process { siginh rlimitinh };
 ')
 
+# allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
+allow init su:process transition;
+dontaudit init su:process noatsecure;
+allow init su:process { siginh rlimitinh };
+
 # Allow init to figure out name of dm-device from it's /dev/block/dm-XX path.
 # This is useful in case of remounting ext4 userdata into checkpointing mode,
 # since it potentially requires tearing down dm-devices (e.g. dm-bow, dm-crypto)
diff --git a/prebuilts/api/34.0/private/su.te b/prebuilts/api/34.0/private/su.te
index cc00e103b..7c99a0ba5 100644
--- a/prebuilts/api/34.0/private/su.te
+++ b/prebuilts/api/34.0/private/su.te
@@ -1,4 +1,3 @@
-userdebug_or_eng(`
   typeattribute su coredomain;
 
   domain_auto_trans(shell, su_exec, su)
@@ -32,4 +31,3 @@ userdebug_or_eng(`
 
   # Allow root to set MTE permissive mode.
   set_prop(su, permissive_mte_prop);
-')
diff --git a/private/init.te b/private/init.te
index 9d3a2c380..f34d166ab 100644
--- a/private/init.te
+++ b/private/init.te
@@ -28,13 +28,13 @@ domain_trans(init, { rootfs toolbox_exec }, modprobe)
 userdebug_or_eng(`
   # case where logpersistd is actually logcat -f in logd context (nee: logcatd)
   domain_auto_trans(init, logcat_exec, logpersist)
-
-  # allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
-  allow init su:process transition;
-  dontaudit init su:process noatsecure;
-  allow init su:process { siginh rlimitinh };
 ')
 
+# allow init to execute services marked with seclabel u:r:su:s0 in userdebug/eng
+allow init su:process transition;
+dontaudit init su:process noatsecure;
+allow init su:process { siginh rlimitinh };
+
 # Allow init to figure out name of dm-device from it's /dev/block/dm-XX path.
 # This is useful in case of remounting ext4 userdata into checkpointing mode,
 # since it potentially requires tearing down dm-devices (e.g. dm-bow, dm-crypto)
diff --git a/private/su.te b/private/su.te
index 2e0d10ae8..5b5cd3d71 100644
--- a/private/su.te
+++ b/private/su.te
@@ -1,4 +1,3 @@
-userdebug_or_eng(`
   typeattribute su coredomain;
 
   domain_auto_trans(shell, su_exec, su)
@@ -33,4 +32,3 @@ userdebug_or_eng(`
 
   # Allow root to set MTE permissive mode.
   set_prop(su, permissive_mte_prop);
-')
-- 
2.45.2

